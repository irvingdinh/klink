name: Release

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        uses: PaulHatch/semantic-version@v5.4.0
        with:
          tag_prefix: "v"
          minor_pattern: "^feat"
          minor_regexp_flags: "i"
          version_format: "${major}.${minor}.${patch}"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build binaries
        run: |
          VERSION="v${{ steps.version.outputs.version }}"

          # macOS ARM64
          bun build --compile --minify src/index.ts \
            --target=bun-darwin-arm64 \
            --outfile "klink-${VERSION}-macos-arm64"

          # macOS x64
          bun build --compile --minify src/index.ts \
            --target=bun-darwin-x64 \
            --outfile "klink-${VERSION}-macos-x64"

          # Linux ARM64
          bun build --compile --minify src/index.ts \
            --target=bun-linux-arm64 \
            --outfile "klink-${VERSION}-linux-arm64"

          # Linux x64
          bun build --compile --minify src/index.ts \
            --target=bun-linux-x64 \
            --outfile "klink-${VERSION}-linux-x64"

          # Windows x64
          bun build --compile --minify src/index.ts \
            --target=bun-windows-x64 \
            --outfile "klink-${VERSION}-windows-x64.exe"

      - name: Prepare release notes
        id: notes
        run: |
          VERSION="v${{ steps.version.outputs.version }}"
          
          # Get commit message
          MESSAGE=$(git log -1 --pretty=%B)
          
          # Read template and replace placeholder
          # Use awk to handle potential special characters better than simple variable substitution
          TEMPLATE=$(cat .github/release_template.md)
          INSTRUCTIONS=${TEMPLATE//\{\{VERSION\}\}/$VERSION}
          
          # Output with a random delimiter to avoid conflicts
          DELIMITER="EOF_$(date +%s)"
          echo "notes<<$DELIMITER" >> $GITHUB_OUTPUT
          echo "$MESSAGE" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "$INSTRUCTIONS" >> $GITHUB_OUTPUT
          echo "$DELIMITER" >> $GITHUB_OUTPUT

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          body: ${{ steps.notes.outputs.notes }}
          draft: true
          files: |
            klink-v${{ steps.version.outputs.version }}-macos-arm64
            klink-v${{ steps.version.outputs.version }}-macos-x64
            klink-v${{ steps.version.outputs.version }}-linux-arm64
            klink-v${{ steps.version.outputs.version }}-linux-x64
            klink-v${{ steps.version.outputs.version }}-windows-x64.exe
